// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // <--- Esta é a correção
  url      = env("DATABASE_URL")
}

model Usuario {
  id               Int       @id @default(autoincrement())
  nome             String
  email            String    @unique
  senha_hash       String
  role             String    @default("user")
  status           String    @default("active")
  ultimo_login     DateTime?
  tentativas_login Int       @default(0)
  bloqueado_ate    DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  @@map("usuarios")
}

model Mentor {
  id          Int      @id @default(autoincrement())
  nome        String
  email       String   @unique
  telefone    String?
  especialidade String?
  bio         String?
  linkedin    String?
  github      String?
  avatar_url  String?
  ativo       Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relacionamentos
  projetos    Projeto[]
  equipes     Equipe[]

  @@map("mentores")
}

model Projeto {
  id          Int      @id @default(autoincrement())
  titulo      String
  descricao   String?
  data_inicio String?
  status      String   @default("rascunho")
  preco       Float?
  visivel     Boolean  @default(false)
  thumb_url   String?
  mentor_id   Int?
  progresso   Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relacionamentos
  mentor      Mentor?  @relation(fields: [mentor_id], references: [id])
  equipes     Equipe[]
  inscricoes  Inscricao[]
  financas    Financa[]

  @@map("projetos")
}

model Crafter {
  id                    Int      @id @default(autoincrement())
  nome                  String
  email                 String?  @unique
  telefone              String?
  cidade                String?
  estado                String?
  area_interesse        String?
  nivel_experiencia     String?
  linkedin              String?
  github                String?
  portfolio             String?
  avatar_url            String?
  bio                   String?
  points                Int      @default(0)
  active                Boolean  @default(true)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relacionamentos
  equipes               Equipe[]
  inscricoes            Inscricao[]
  inscricoes_desafios   InscricaoDesafio[]
  submissions           Submission[]
  top3                  Top3[]

  @@map("crafters")
}

model Financa {
  id          Int      @id @default(autoincrement())
  item        String
  valor       Float
  status      String   @default("pending")
  date        DateTime
  type        String   @default("other")
  project_id  Int?
  progress    Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relacionamentos
  projeto     Projeto? @relation(fields: [project_id], references: [id])

  @@map("financas")
}

model Equipe {
  id               Int      @id @default(autoincrement())
  mentor_id        Int
  crafter_id       Int
  projeto_id       Int
  status_inscricao String   @default("inscrito")
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relacionamentos
  mentor           Mentor   @relation(fields: [mentor_id], references: [id])
  crafter          Crafter  @relation(fields: [crafter_id], references: [id])
  projeto          Projeto  @relation(fields: [projeto_id], references: [id])

  @@map("equipes")
}

model Inscricao {
  id         Int      @id @default(autoincrement())
  crafter_id Int
  projeto_id Int
  status     String   @default("pendente")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  crafter    Crafter  @relation(fields: [crafter_id], references: [id])
  projeto    Projeto  @relation(fields: [projeto_id], references: [id])

  @@map("inscricoes")
}

model Desafio {
  id            Int      @id @default(autoincrement())
  name          String
  objective     String
  description   String   @default("")
  deadline      DateTime
  base_points   Int      @default(0)
  reward        String   @default("")
  status        String   @default("draft")
  criteria      String   @default("[]") // JSON string
  delivery_type String
  visible       Boolean  @default(false)
  difficulty    String   @default("starter")
  tags          String   @default("[]") // JSON string
  thumb_url     String?
  created_by    String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relacionamentos
  inscricoes    InscricaoDesafio[]
  submissions   Submission[]
  logs          Log[]

  @@map("desafios")
}

model InscricaoDesafio {
  id          Int      @id @default(autoincrement())
  crafter_id  Int
  desafio_id  Int
  enrolled_at DateTime

  // Relacionamentos
  crafter     Crafter  @relation(fields: [crafter_id], references: [id])
  desafio     Desafio  @relation(fields: [desafio_id], references: [id])

  @@map("inscricoes_desafios")
}

model Submission {
  id           Int      @id @default(autoincrement())
  challenge_id Int
  crafter_id   Int
  submitted_at DateTime
  delivery     String   // JSON string
  status       String   @default("submitted")
  review       String?  // JSON string
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relacionamentos
  desafio      Desafio  @relation(fields: [challenge_id], references: [id])
  crafter      Crafter  @relation(fields: [crafter_id], references: [id])
  logs         Log[]

  @@map("submissions")
}

model Log {
  id            Int         @id @default(autoincrement())
  type          String
  at            DateTime
  actor         String
  challenge_id  Int?
  submission_id Int?
  data          String?     // JSON string

  // Relacionamentos
  desafio       Desafio?    @relation(fields: [challenge_id], references: [id])
  submission    Submission? @relation(fields: [submission_id], references: [id])

  @@map("logs")
}

model RankingSetting {
  id          Int      @id @default(autoincrement())
  week_ref    String?
  min_points  Int      @default(0)
  max_points  Int?
  active_only Boolean  @default(true)
  search      String   @default("")
  updated_at  DateTime @default(now())
  updated_by  String   @default("system")

  @@map("ranking_settings")
}

model Top3 {
  id         Int     @id @default(autoincrement())
  crafter_id Int
  position   Int
  reward     String  @default("")

  // Relacionamentos
  crafter    Crafter @relation(fields: [crafter_id], references: [id])

  @@map("top3")
}

model RankingHistory {
  id            Int      @id @default(autoincrement())
  at            DateTime
  actor         String
  action        String
  crafter_id    Int?
  before_points Int?
  after_points  Int?
  diff          Int?
  @@map("ranking_history")
}

model Feedback {
  id           Int      @id @default(autoincrement())
  nome         String
  email        String?
  mensagem     String
  origem       String   @default("pagina_inicial")
  data_criacao DateTime @default(now())

  @@map("feedbacks")
}

model InscricaoCrafter {
  id             Int      @id @default(autoincrement())
  nome           String
  email          String
  telefone       String?
  cidade         String?
  estado         String?
  area_interesse String?
  mensagem       String?
  status         String   @default("pendente")
  data_inscricao DateTime @default(now())

  @@map("inscricoes_crafters")
}