import{u as e,j as a,F as s,ae as r,a8 as t,as as i,$ as n,ah as l,at as o,a7 as c,a2 as d,s as m,a9 as x,a as _}from"./index-DQkRuPgL.js";import{r as h}from"./router-Bh7m2j_b.js";import{b as p,u,R as j}from"./useAdminRepo-CbCCtI2A.js";import{A as v}from"./AdminCard-ChVCY5T3.js";import{S as N}from"./StatusBadge-C-iKibtv.js";import"./realtime-BxkdmVbQ.js";import"./projectsAPI-me_sk8Ob.js";import"./dataCache-D0LcSMWP.js";import"./rankingAPI-BHWt9I6k.js";import"./userAPI-B3dychSI.js";const f="_page_1frrx_7",b="_header_1frrx_17",g="_headerTitle_1frrx_35",y="_headerIcon_1frrx_47",C="_newBtn_1frrx_89",S="_toast_1frrx_131",k="_sectionTitle_1frrx_173",P="_podiumCard_1frrx_195",A="_podiumGrid_1frrx_207",w="_podiumSlot_1frrx_221",B="_selected_1frrx_243",$="_duplicate_1frrx_253",E="_podiumHeader_1frrx_263",R="_podiumPosition_1frrx_275",T="_gold_1frrx_285",I="_silver_1frrx_287",L="_bronze_1frrx_289",z="_podiumSelect_1frrx_293",D="_podiumReward_1frrx_295",O="_podiumPoints_1frrx_327",U="_podiumError_1frrx_343",Z="_podiumSuccess_1frrx_369",F="_podiumActions_1frrx_395",G="_filtersCard_1frrx_407",J="_filtersGrid_1frrx_419",M="_searchBox_1frrx_433",H="_searchIcon_1frrx_445",Q="_searchInput_1frrx_463",W="_input_1frrx_495",q="_select_1frrx_243",K="_inputError_1frrx_531",V="_checkboxLabel_1frrx_539",X="_resetBtn_1frrx_571",Y="_tableCard_1frrx_609",ee="_tableWrapper_1frrx_619",ae="_table_1frrx_609",se="_emptyRow_1frrx_693",re="_avatar_1frrx_705",te="_avatarPlaceholder_1frrx_719",ie="_pointsBadge_1frrx_745",ne="_actionBtns_1frrx_769",le="_actionBtn_1frrx_769",oe="_actionBtnOutline_1frrx_783",ce="_actionBtnDanger_1frrx_785",de="_modalBackdrop_1frrx_881",me="_modal_1frrx_881",xe="_modalHeader_1frrx_921",_e="_closeBtn_1frrx_957",he="_modalBody_1frrx_991",pe="_modalError_1frrx_999",ue="_formRow_1frrx_1019",je="_formGroup_1frrx_1033",ve="_fieldError_1frrx_1057",Ne="_avatarPreview_1frrx_1067",fe="_modalFooter_1frrx_1095",be="_saveBtn_1frrx_1109",ge="_clearBtn_1frrx_1111",ye="_cancelBtn_1frrx_1113",Ce="_loadingState_1frrx_1207",Se="_spinner_1frrx_1227",ke="_errorState_1frrx_1253",Pe="_retryBtn_1frrx_1283";function Ae(){const{data:Ae,loading:we,error:Be,refresh:$e}=p(),{user:Ee}=e(),{reload:Re}=u({active_only:"true",limit:20,order_by:"points",order_direction:"desc"}),[Te,Ie]=h.useState(!1),[Le,ze]=h.useState({search:"",min_points:"",max_points:"",active_only:!0,sort:"points_desc"}),[De,Oe]=h.useState({name:"",avatar_url:"",points:0,active:!0}),[Ue,Ze]=h.useState({}),[Fe,Ge]=h.useState(!1),[Je,Me]=h.useState({open:!1,item:null,saving:!1,error:""}),[He,Qe]=h.useState(""),We=h.useMemo(()=>!Ae||Array.isArray(Ae)?{top3:[],table:[],all:[]}:{top3:Ae.top3||[],table:Ae.table||[],all:Ae.all||Ae.crafters||[]},[Ae]),qe=h.useMemo(()=>Array.isArray(We.all)?[...We.all].sort((e,a)=>Number(a.points??a.pontos??0)-Number(e.points??e.pontos??0)):[],[We.all]),[Ke,Ve]=h.useState([]),[Xe,Ye]=h.useState({});h.useEffect(()=>{if(We.top3){const e=[...We.top3].sort((e,a)=>Number(e.position)-Number(a.position));Ve(e);const a={};e.forEach(e=>{a[e.position]=e.reward||""}),Ye(a)}},[We.top3]);const ea=e=>{Qe(e),setTimeout(()=>Qe(""),2500)},aa=async(e,a,s="")=>{Ie(!0);try{await j.updatePoints(e,{delta:a,reason:s||`Ajuste manual ${a>0?"+":""}${a}`}),ea(`Pontos ${a>0?"adicionados":"removidos"} com sucesso`),$e()}finally{Ie(!1)}},sa=async(e,a,s="")=>{Ie(!0);try{await j.updatePoints(e,{set:a,reason:s||`Definir ${a} pontos`}),ea("Pontos definidos com sucesso"),$e()}finally{Ie(!1)}},ra=h.useMemo(()=>{let e=[...We.table||[]];return Le.search&&(e=e.filter(e=>e.name?.toLowerCase().includes(Le.search.toLowerCase()))),Le.min_points&&(e=e.filter(e=>e.points>=Number(Le.min_points))),Le.max_points&&(e=e.filter(e=>e.points<=Number(Le.max_points))),Le.active_only&&(e=e.filter(e=>!1!==e.active)),"points_desc"===Le.sort?e.sort((e,a)=>Number(a.points||0)-Number(e.points||0)):"points_asc"===Le.sort?e.sort((e,a)=>Number(e.points||0)-Number(a.points||0)):"name_asc"===Le.sort?e.sort((e,a)=>String(e.name||"").localeCompare(String(a.name||""))):"name_desc"===Le.sort&&e.sort((e,a)=>String(a.name||"").localeCompare(String(e.name||""))),e},[We.table,Le]),ta=(Ke||[]).filter(e=>e?.id).map(e=>e.id),ia=ta.length!==new Set(ta).size,na=3===(Ke||[]).length&&(Ke||[]).every(e=>e?.id);return we?a.jsx("div",{className:f,children:a.jsxs("div",{className:Ce,children:[a.jsx("div",{className:Se}),a.jsx("p",{children:"Carregando ranking..."})]})}):Be?a.jsx("div",{className:f,children:a.jsx(v,{variant:"outlined",children:a.jsxs("div",{className:ke,children:[a.jsx("h3",{children:"Erro ao carregar ranking"}),a.jsx("p",{children:Be}),a.jsx("button",{onClick:$e,className:Pe,children:"Tentar novamente"})]})})}):a.jsxs("div",{className:f,children:[a.jsxs("header",{className:b,children:[a.jsxs("div",{className:g,children:[a.jsx(s,{className:y}),a.jsxs("div",{children:[a.jsx("h1",{children:"Ranking de Crafters"}),a.jsxs("p",{children:[qe.length," crafters no ranking"]})]})]}),a.jsxs("button",{onClick:()=>Ge(!0),className:C,children:[a.jsx(r,{})," Novo Crafter"]})]}),He&&a.jsxs("div",{className:S,children:[a.jsx(t,{})," ",He]}),a.jsxs(v,{variant:"elevated",className:P,children:[a.jsxs("h2",{className:k,children:[a.jsx(i,{})," Editor de Pódio"]}),a.jsx("div",{className:A,children:[1,2,3].map(e=>{const s=(Ke||[]).find(a=>a.position===e)||(Ke||[])[e-1],r=s?.id,i=r&&(Ke||[]).filter(e=>e.id===s.id).length>1;return a.jsxs("div",{className:`${w} ${i?$:""} ${r?B:""}`,children:[a.jsxs("div",{className:E,children:[a.jsxs("span",{className:R,children:[1===e&&a.jsx("span",{className:T,children:"1º"}),2===e&&a.jsx("span",{className:I,children:"2º"}),3===e&&a.jsx("span",{className:L,children:"3º"})]}),i&&a.jsx(N,{variant:"error",size:"sm",children:"Duplicado"})]}),a.jsxs("select",{value:s?.id||"",onChange:a=>{const s=qe.find(e=>e.id===a.target.value);if(s){const a=[...Ke];a[e-1]={...s,position:e},Ve(a)}else{const a=[...Ke];a[e-1]=null,Ve(a.filter(Boolean))}},className:z,children:[a.jsx("option",{value:"",children:"Selecionar crafter"}),qe.map(e=>a.jsxs("option",{value:e.id,children:[e.name," (",e.points," pts)"]},e.id))]}),a.jsx("input",{placeholder:"Recompensa (opcional)",value:Xe[e]||"",onChange:a=>Ye(s=>({...s,[e]:a.target.value})),className:D}),r&&a.jsxs("div",{className:O,children:[a.jsx(t,{})," ",s.points," pontos"]})]},e)})}),ia&&a.jsxs("div",{className:U,children:[a.jsx(n,{})," Não é possível selecionar o mesmo crafter em múltiplas posições"]}),na&&!ia&&a.jsxs("div",{className:Z,children:[a.jsx(t,{})," Pódio completo! Pronto para salvar"]}),a.jsxs("div",{className:F,children:[a.jsxs("button",{onClick:async()=>{Ie(!0);try{const e=(Ke||[]).map((e,a)=>({crafter_id:e.id,position:a+1,reward:Xe[a+1]||""})),a=await j.updateTop3(e);if(a?.ok&&a?.result?.data?.top3){const e=a.result.data.top3.map(e=>({id:e.crafter_id,name:e.name||"",points:Number(e.points||0),avatar_url:e.avatar_url||"",position:e.position})).sort((e,a)=>Number(e.position)-Number(a.position));Ve(e);const s={};e.forEach(e=>{s[e.position]=e.reward||""}),Ye(s)}ea("Pódio salvo com sucesso!"),$e()}finally{Ie(!1)}},disabled:Te||!na||ia,className:be,children:[a.jsx(l,{})," Salvar Pódio"]}),a.jsxs("button",{onClick:()=>{Ve([]),Ye({})},disabled:Te||0===ta.length,className:ge,children:[a.jsx(n,{})," Limpar"]})]})]}),a.jsxs(v,{variant:"elevated",className:G,children:[a.jsxs("h3",{className:k,children:[a.jsx(o,{})," Filtros"]}),a.jsxs("div",{className:J,children:[a.jsxs("div",{className:M,children:[a.jsx(c,{className:H}),a.jsx("input",{type:"text",placeholder:"Buscar por nome...",value:Le.search,onChange:e=>ze(a=>({...a,search:e.target.value})),className:Q})]}),a.jsx("input",{type:"number",placeholder:"Pontos mín.",value:Le.min_points,onChange:e=>ze(a=>({...a,min_points:e.target.value})),className:W}),a.jsx("input",{type:"number",placeholder:"Pontos máx.",value:Le.max_points,onChange:e=>ze(a=>({...a,max_points:e.target.value})),className:W}),a.jsxs("select",{value:Le.sort,onChange:e=>ze(a=>({...a,sort:e.target.value})),className:q,children:[a.jsx("option",{value:"points_desc",children:"Pontos (maior)"}),a.jsx("option",{value:"points_asc",children:"Pontos (menor)"}),a.jsx("option",{value:"name_asc",children:"Nome A-Z"}),a.jsx("option",{value:"name_desc",children:"Nome Z-A"})]}),a.jsxs("label",{className:V,children:[a.jsx("input",{type:"checkbox",checked:Le.active_only,onChange:e=>ze(a=>({...a,active_only:e.target.checked}))}),"Apenas ativos"]}),a.jsxs("button",{onClick:()=>{ze({search:"",min_points:"",max_points:"",active_only:!0,sort:"points_desc"})},className:X,children:[a.jsx(d,{})," Resetar"]})]})]}),a.jsxs(v,{variant:"elevated",className:Y,children:[a.jsxs("h3",{className:k,children:[a.jsx(s,{})," Tabela Geral"]}),a.jsx("div",{className:ee,children:a.jsxs("table",{className:ae,children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Pos"}),a.jsx("th",{children:"Avatar"}),a.jsx("th",{children:"Nome"}),a.jsx("th",{children:"Pontos"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Ações"})]})}),a.jsx("tbody",{children:0===ra.length?a.jsx("tr",{children:a.jsxs("td",{colSpan:"6",className:se,children:[a.jsx(m,{})," Nenhum crafter encontrado"]})}):ra.map((e,s)=>a.jsxs("tr",{children:[a.jsx("td",{"data-label":"Pos",children:s+1}),a.jsx("td",{"data-label":"Avatar",children:e.avatar_url?a.jsx("img",{src:e.avatar_url,alt:e.name,className:re}):a.jsx("div",{className:te,children:e.name?.charAt(0).toUpperCase()})}),a.jsx("td",{"data-label":"Nome",children:e.name}),a.jsx("td",{"data-label":"Pontos",children:a.jsxs("span",{className:ie,children:[a.jsx(t,{})," ",e.points," pts"]})}),a.jsx("td",{"data-label":"Status",children:a.jsx(N,{variant:!1!==e.active?"success":"neutral",children:!1!==e.active?"Ativo":"Inativo"})}),a.jsx("td",{"data-label":"Ações",children:a.jsxs("div",{className:ne,children:[a.jsx("button",{onClick:()=>aa(e.id,10),disabled:Te,className:le,title:"+10",children:"+10"}),a.jsx("button",{onClick:()=>aa(e.id,-10),disabled:Te,className:le,title:"-10",children:"-10"}),a.jsx("button",{onClick:()=>{const a=prompt("Definir pontos:",e.points);null===a||isNaN(a)||sa(e.id,Number(a))},disabled:Te,className:oe,title:"Definir",children:"SET"}),a.jsx("button",{onClick:()=>{window.confirm(`Zerar pontos de ${e.name}?`)&&sa(e.id,0,"Zerado pelo admin")},disabled:Te,className:ce,title:"Zerar",children:"0"}),a.jsx("button",{onClick:()=>(async(e,a)=>{Ie(!0);try{await _(`/api/crafters/${e}`,{method:"PUT",body:JSON.stringify(a)}),ea("Crafter atualizado!"),$e()}finally{Ie(!1)}})(e.id,{active:!e.active}),disabled:Te,className:oe,children:!1!==e.active?"Desativar":"Ativar"})]})})]},e.id))})]})})]}),Fe&&a.jsx("div",{className:de,children:a.jsxs("div",{className:me,children:[a.jsxs("div",{className:xe,children:[a.jsxs("h3",{children:[a.jsx(r,{})," Novo Crafter"]}),a.jsx("button",{onClick:()=>{Ge(!1),Ze({})},className:_e,children:a.jsx(n,{})})]}),a.jsxs("div",{className:he,children:[a.jsxs("div",{className:ue,children:[a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Nome *"}),a.jsx("input",{type:"text",placeholder:"Nome do crafter",value:De.name,onChange:e=>Oe(a=>({...a,name:e.target.value})),className:`${W} ${Ue.name?K:""}`}),Ue.name&&a.jsx("span",{className:ve,children:Ue.name})]}),a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Avatar URL"}),a.jsx("input",{type:"url",placeholder:"https://...",value:De.avatar_url,onChange:e=>Oe(a=>({...a,avatar_url:e.target.value})),className:`${W} ${Ue.avatar_url?K:""}`}),Ue.avatar_url&&a.jsx("span",{className:ve,children:Ue.avatar_url})]})]}),a.jsxs("div",{className:ue,children:[a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Pontos iniciais"}),a.jsx("input",{type:"number",placeholder:"0",value:De.points,onChange:e=>Oe(a=>({...a,points:Number(e.target.value)})),className:`${W} ${Ue.points?K:""}`}),Ue.points&&a.jsx("span",{className:ve,children:Ue.points})]}),a.jsx("div",{className:je,children:a.jsxs("label",{className:V,children:[a.jsx("input",{type:"checkbox",checked:De.active,onChange:e=>Oe(a=>({...a,active:e.target.checked}))}),"Ativo"]})})]}),De.avatar_url&&a.jsx("div",{className:Ne,children:a.jsx("img",{src:De.avatar_url,alt:"Preview"})})]}),a.jsxs("div",{className:fe,children:[a.jsx("button",{onClick:async()=>{const e=(e=>{const a={};String(e.name||"").trim()||(a.name="Nome é obrigatório"),(""===e.points||isNaN(Number(e.points)))&&(a.points="Pontos inválidos"),Number(e.points)<0&&(a.points="Pontos não podem ser negativos"),String(e.avatar_url||"").trim()&&(/^https?:\/\/\S+/.test(String(e.avatar_url))||(a.avatar_url="URL do avatar inválida"));return a})(De);if(Ze(e),!(Object.keys(e).length>0)){Ie(!0);try{await _("/api/crafters",{method:"POST",body:JSON.stringify(De)}),Oe({name:"",avatar_url:"",points:0,active:!0}),Ge(!1),ea("Crafter criado com sucesso!"),$e()}finally{Ie(!1)}}},disabled:Te||!De.name,className:be,children:Te?"Salvando...":a.jsxs(a.Fragment,{children:[a.jsx(l,{})," Salvar"]})}),a.jsx("button",{onClick:()=>{Ge(!1),Ze({})},className:ye,children:"Cancelar"})]})]})}),Je.open&&a.jsx("div",{className:de,children:a.jsxs("div",{className:me,children:[a.jsxs("div",{className:xe,children:[a.jsxs("h3",{children:[a.jsx(x,{})," Editar Crafter"]}),a.jsx("button",{onClick:()=>Me({open:!1,item:null,saving:!1,error:""}),className:_e,children:a.jsx(n,{})})]}),a.jsxs("div",{className:he,children:[Je.error&&a.jsx("div",{className:pe,children:Je.error}),a.jsxs("div",{className:ue,children:[a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Nome"}),a.jsx("input",{type:"text",value:Je.item?.nome||"",onChange:e=>Me(a=>({...a,item:{...a.item,nome:e.target.value}})),className:W})]}),a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Especialização"}),a.jsx("input",{type:"text",value:Je.item?.nivel||"",onChange:e=>Me(a=>({...a,item:{...a.item,nivel:e.target.value}})),className:W})]})]}),a.jsxs("div",{className:ue,children:[a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Avatar URL"}),a.jsx("input",{type:"url",value:Je.item?.avatar_url||"",onChange:e=>Me(a=>({...a,item:{...a.item,avatar_url:e.target.value}})),className:W})]}),a.jsxs("div",{className:je,children:[a.jsx("label",{children:"Pontos"}),a.jsx("input",{type:"number",value:Je.item?.pontos??0,onChange:e=>Me(a=>({...a,item:{...a.item,pontos:Number(e.target.value)}})),className:W})]})]}),a.jsxs("label",{className:V,children:[a.jsx("input",{type:"checkbox",checked:Je.item?.ativo??!0,onChange:e=>Me(a=>({...a,item:{...a.item,ativo:e.target.checked}}))}),"Ativo"]})]}),a.jsxs("div",{className:fe,children:[a.jsx("button",{onClick:async()=>{if(String(Je.item?.nome||"").trim())try{Me(e=>({...e,saving:!0,error:""})),await _(`/api/crafters/${Je.item.id}`,{method:"PUT",body:JSON.stringify({nome:Je.item.nome,nivel:Je.item.nivel,avatar_url:Je.item.avatar_url,pontos:Number(Je.item.pontos||0),ativo:!!Je.item.ativo})}),Me({open:!1,item:null,saving:!1,error:""}),ea("Crafter atualizado!"),Re()}catch(e){Me(a=>({...a,saving:!1,error:e.message||"Falha ao salvar"}))}else Me(e=>({...e,error:"Nome é obrigatório"}))},disabled:Je.saving||"admin"!==Ee?.role,className:be,children:Je.saving?"Salvando...":"Salvar"}),a.jsx("button",{onClick:()=>Me({open:!1,item:null,saving:!1,error:""}),className:ye,children:"Cancelar"})]})]})})]})}export{Ae as default};
