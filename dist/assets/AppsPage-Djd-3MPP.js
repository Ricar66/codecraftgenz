import{j as a,a as e,A as s}from"./index-BTqv4jWw.js";import{r as t,d as r}from"./router-5U3rcizL.js";import{A as o}from"./AppCard-DN8OY0qD.js";import{N as i}from"./Navbar-BQrvc9jP.js";import{g as c,a as n,u as d,b as l}from"./appsAPI-DOoFz6qt.js";import{g as p}from"./projectsAPI-Bs0iocQc.js";import{a as u}from"./appModel-AsaTK777.js";import{a as h}from"./dataCache-D0LcSMWP.js";import{g as m}from"./performanceMonitor-Dl9f24Uw.js";import"./urlSanitize-Bu_u8ZdG.js";function _({appId:s}){const[r,o]=t.useState(""),[i,c]=t.useState(""),[n,d]=t.useState(""),[l,p]=t.useState(!1);return a.jsxs("div",{style:{marginTop:12,background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:12,padding:12},children:[a.jsx("h3",{className:"title",style:{fontSize:"1rem"},children:"AtivaÃ§Ã£o de LicenÃ§a Offline"}),a.jsx("p",{className:"muted",children:"Cole abaixo o seu Hardware ID para gerar a licenÃ§a deste app."}),a.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:8,alignItems:"center",marginTop:8},children:[a.jsx("input",{className:"input",placeholder:"Ex: HWID-ABC123...",value:r,onChange:a=>o(a.target.value),"aria-label":"Hardware ID"}),a.jsx("button",{className:"btn btn-primary",onClick:async()=>{if(d(""),c(""),r&&s){p(!0);try{const a=await e("/api/licenses/activate",{method:"POST",body:JSON.stringify({appId:Number(s),hardwareId:String(r).trim()})});a?.success?c(a.license_key||a.data?.license_key||""):d(a?.error||"Falha ao gerar licenÃ§a")}catch(a){d(a?.message||"Erro de rede")}finally{p(!1)}}else d("Preencha o Hardware ID.")},disabled:l,children:l?"Gerandoâ€¦":"Gerar LicenÃ§a"})]}),n&&a.jsxs("p",{role:"alert",style:{color:"#FF6B6B",marginTop:8},children:["âŒ ",n]}),i&&a.jsxs("div",{style:{marginTop:8},children:[a.jsx("label",{className:"muted",children:"LicenÃ§a Gerada"}),a.jsx("textarea",{readOnly:!0,value:i,rows:3,style:{width:"100%",padding:10,borderRadius:10,border:"1px solid rgba(255,255,255,0.18)",background:"rgba(0,0,0,0.25)",color:"var(--texto-branco)"}})]})]})}const g="_page_c5d4t_9",j="_content_c5d4t_55",x="_hero_c5d4t_67",v="_heroTitle_c5d4t_83",y="_heroSubtitle_c5d4t_111",N="_actionsBar_c5d4t_129",f="_publishBtn_c5d4t_141",b="_publishBtnActive_c5d4t_183",w="_filtersSection_c5d4t_195",S="_filtersContainer_c5d4t_207",C="_searchInput_c5d4t_231",A="_filterSelect_c5d4t_277",k="_appsSection_c5d4t_323",T="_appsGrid_c5d4t_335",E="_appCardWrapper_c5d4t_349",I="_licenseToggleBtn_c5d4t_359",$="_licenseExpanded_c5d4t_407",B="_emptyState_c5d4t_425",P="_emptyIcon_c5d4t_443",F="_emptyTitle_c5d4t_455",L="_emptyText_c5d4t_467",D="_loadingState_c5d4t_479",M="_errorState_c5d4t_493",O="_publishSection_c5d4t_509",R="_publishCard_c5d4t_521",z="_publishTitle_c5d4t_537",W="_publishMessage_c5d4t_551",H="_projectsGrid_c5d4t_561",U="_projectCard_c5d4t_573",G="_projectInfo_c5d4t_609",q="_projectTitle_c5d4t_619",V="_projectDesc_c5d4t_633",J="_projectActions_c5d4t_653",K="_projectPublishBtn_c5d4t_661",Q="_historySection_c5d4t_707",X="_historyCard_c5d4t_719",Y="_historyTitle_c5d4t_733",Z="_historyTable_c5d4t_747",aa="_historyEmpty_c5d4t_813",ea="_modalBackdrop_c5d4t_827",sa="_modal_c5d4t_827",ta="_modalTitle_c5d4t_871",ra="_modalDescription_c5d4t_885",oa="_modalPrice_c5d4t_897",ia="_modalError_c5d4t_911",ca="_modalActions_c5d4t_931",na="_btnPrimary_c5d4t_945",da="_btnOutline_c5d4t_989",la="_progressContainer_c5d4t_1035",pa="_progressBar_c5d4t_1043",ua="_progressFill_c5d4t_1061",ha="_progressText_c5d4t_1075",ma=a=>{if(!a)return"";if(a.startsWith("http://")||a.startsWith("https://"))return a;const e=a.startsWith("/")?a:`/${a}`;return e.startsWith("/api/")?`${s}${e}`:e.startsWith("/downloads/")?`${s}/api${e}`:`${s}${e}`},_a=()=>{const _a=r(),[ga,ja]=t.useState([]),[xa,va]=t.useState(!0),[ya,Na]=t.useState(""),[fa,ba]=t.useState([]),[wa,Sa]=t.useState(!1),[Ca,Aa]=t.useState([]),[ka,Ta]=t.useState(!1),[Ea,Ia]=t.useState(""),[$a,Ba]=t.useState(""),[Pa,Fa]=t.useState("todas"),[La,Da]=t.useState("categoria"),[Ma,Oa]=t.useState({open:!1,app:null,loading:!1,error:""}),[Ra,za]=t.useState({});t.useEffect(()=>{let a=!0;return(async()=>{try{va(!0);const e=`apps-load-${Date.now()}`;m.startMeasure(e,{page:1,pageSize:24});const s=h.generateKey("public-apps",{page:1,pageSize:24}),t=h.get(s);let r;t?r=t:(r=await c({page:1,pageSize:24,sortBy:"updatedAt"}),h.set(s,r,3e5));const o=Array.isArray(r?.data)?r.data:Array.isArray(r)?r:[];a&&ja(o);const i=await n({page:1,pageSize:10}).catch(()=>({data:[]})),d=Array.isArray(i?.data)?i.data:Array.isArray(i)?i:[];a&&ba(d),m.endMeasure(e,{success:!0,count:o.length})}catch(e){401===e.status?(Na("Nao autenticado"),_a("/login?redirect=/apps")):Na(e.message||"Erro ao carregar aplicativos")}finally{va(!1)}})(),()=>{a=!1}},[_a]),t.useEffect(()=>{if(!wa)return;let a=!0;return(async()=>{try{const e=await p({page:1,limit:12,sortBy:"updatedAt",publicOnly:!1}),s=Array.isArray(e?.data)?e.data:[];a&&Aa(s)}catch(e){}})(),()=>{a=!1}},[wa]);const Wa=t.useMemo(()=>{const a=new Map;for(const e of fa){const s=e.appId||e.app_id;s&&a.set(s,(a.get(s)||0)+1)}return a},[fa]),Ha=t.useMemo(()=>{const a=new Set(["todas"]);for(const e of ga)a.add(e.category||"outros");return Array.from(a)},[ga]),Ua=t.useMemo(()=>{let a=[...ga];if($a){const e=$a.toLowerCase();a=a.filter(a=>String(a.name||"").toLowerCase().includes(e)||String(a.mainFeature||"").toLowerCase().includes(e))}return"todas"!==Pa&&(a=a.filter(a=>(a.category||"outros")===Pa)),"uso"===La?a.sort((a,e)=>(Wa.get(e.id)||0)-(Wa.get(a.id)||0)):a.sort((a,e)=>String(a.category||"outros").localeCompare(String(e.category||"outros"))||String(a.name||"").localeCompare(String(e.name||""))),a},[ga,$a,Pa,La,Wa]),Ga=a=>{Oa({open:!0,app:a,loading:!1,error:""})},qa=async a=>{try{Oa(a=>({...a,status:"downloading",progress:0,downloadError:""}));let e=null;try{const a="undefined"!=typeof localStorage?localStorage.getItem("cc_session"):null;if(a){const s=JSON.parse(a);e=s?.token||null}}catch{e=null}const t=await fetch(`${s}/api/apps/${encodeURIComponent(a.id)}/download`,{method:"POST",headers:{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}},body:"{}"});if(!t.ok){const e=await fetch(`${s}/api/apps/${encodeURIComponent(a.id)}/purchase/status?status=approved`);if(!e.ok)throw new Error(`Falha no download (HTTP ${t.status})`);const r=await e.json().catch(()=>({})),o=ma(r?.download_url||r?.data?.download_url||null);if(!o)throw new Error("Download nao liberado. Pagamento nao aprovado.");return window.location.href=o,void Oa(a=>({...a,status:"done",progress:100}))}const r=await t.json().catch(()=>({})),o=ma(r?.download_url||null);if(!o)throw new Error("Aplicativo sem URL de executavel configurada");window.location.href=o,Oa(a=>({...a,status:"done",progress:100}))}catch(e){Oa(a=>({...a,status:"error",downloadError:e.message||"Erro no download"}))}};return a.jsxs("div",{className:g,children:[a.jsx(i,{}),a.jsxs("div",{className:j,children:[a.jsxs("header",{className:x,children:[a.jsx("h1",{className:v,children:"Meus Aplicativos"}),a.jsx("p",{className:y,children:"Baixe e compre seus apps com visual profissional. Explore nossa colecao de aplicativos desenvolvidos pela comunidade CodeCraft."}),a.jsx("div",{className:N,children:a.jsx("button",{className:`${f} ${wa?b:""}`,onClick:()=>Sa(a=>!a),children:wa?"Fechar publicacao":"Publicar projeto"})})]}),a.jsx("section",{className:w,children:a.jsxs("div",{className:S,children:[a.jsx("input",{type:"text",placeholder:"Buscar aplicativos...",value:$a,onChange:a=>Ba(a.target.value),className:C,"aria-label":"Buscar aplicativos"}),a.jsx("select",{value:Pa,onChange:a=>Fa(a.target.value),className:A,"aria-label":"Filtrar por categoria",children:Ha.map(e=>a.jsx("option",{value:e,children:e},e))}),a.jsxs("select",{value:La,onChange:a=>Da(a.target.value),className:A,"aria-label":"Ordenar por",children:[a.jsx("option",{value:"categoria",children:"Categoria"}),a.jsx("option",{value:"uso",children:"Uso frequente"})]})]})}),xa&&a.jsx("p",{className:D,children:"Carregando seus apps..."}),ya&&a.jsx("p",{className:M,children:ya}),a.jsx("section",{className:k,children:0!==ga.length||xa?a.jsx("div",{className:T,children:Ua.map(e=>{return a.jsxs("div",{className:E,children:[a.jsx(o,{app:e,onDownload:Ga}),(s=e,("coincraft"===String(s.name||"").toLowerCase()||s.requiresLicense||s.licenseRequired||s.license&&s.license.required)&&a.jsxs(a.Fragment,{children:[a.jsx("button",{className:I,onClick:()=>{return a=e.id,void za(e=>({...e,[a]:!e[a]}));var a},children:Ra[e.id]?"Ocultar Ativacao":"Ativar Licenca"}),Ra[e.id]&&a.jsx("div",{className:$,children:a.jsx(_,{appId:e.id})})]}))]},e.id);var s})}):a.jsxs("div",{className:B,children:[a.jsx("div",{className:P,children:"ðŸ“¦"}),a.jsx("h3",{className:F,children:"Nenhum aplicativo disponivel"}),a.jsx("p",{className:L,children:"Volte em breve para conferir novos aplicativos da comunidade."})]})}),wa&&a.jsx("section",{className:O,children:a.jsxs("div",{className:R,children:[a.jsx("h2",{className:z,children:"Publicar a partir de projetos"}),Ea&&a.jsx("p",{className:W,children:Ea}),0===Ca.length?a.jsxs("div",{className:B,children:[a.jsx("div",{className:P,children:"ðŸ“"}),a.jsx("h3",{className:F,children:"Nenhum projeto disponivel"}),a.jsx("p",{className:L,children:"Crie um projeto primeiro para poder publica-lo."})]}):a.jsx("div",{className:H,children:Ca.map(e=>a.jsxs("div",{className:U,children:[a.jsxs("div",{className:G,children:[a.jsx("h3",{className:q,children:e.title}),a.jsx("p",{className:V,children:e.description})]}),a.jsx("div",{className:J,children:a.jsx("button",{className:K,disabled:ka,onClick:()=>(async a=>{try{Ta(!0),Ia("Publicando..."),await d(a.id,{price:a.price??0,mainFeature:a.description??a.title}),Ia("Projeto publicado com sucesso!");const e=await c({page:1,pageSize:24,sortBy:"updatedAt"}),s=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];ja(s)}catch(e){Ia(e.message||"Erro ao publicar projeto")}finally{Ta(!1)}})(e),children:"Publicar"})})]},e.id))})]})}),a.jsx("section",{className:Q,children:a.jsxs("div",{className:X,children:[a.jsx("h2",{className:Y,children:"Historico de compras e downloads"}),0===fa.length?a.jsx("p",{className:aa,children:"Sem historico de compras ou downloads."}):a.jsxs("table",{className:Z,children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"App"}),a.jsx("th",{children:"Tipo"}),a.jsx("th",{children:"Data"}),a.jsx("th",{children:"Status"})]})}),a.jsx("tbody",{children:fa.map((e,s)=>a.jsxs("tr",{children:[a.jsx("td",{children:e.app_name||e.appId}),a.jsx("td",{children:e.type}),a.jsx("td",{children:e.date?new Date(e.date).toLocaleString("pt-BR"):"â€”"}),a.jsx("td",{children:e.status||"â€”"})]},s))})]})]})})]}),Ma.open&&a.jsx("div",{className:ea,role:"dialog","aria-modal":"true","aria-label":"Pagamento do aplicativo",children:a.jsxs("div",{className:sa,children:[a.jsx("h3",{className:ta,children:Ma.app?.name}),a.jsx("p",{className:ra,children:Ma.app?.mainFeature}),a.jsxs("p",{className:oa,children:["Preco: ",(()=>{const a=u(Ma.app||{});return a>0?`R$ ${a.toLocaleString("pt-BR")}`:"a definir"})()]}),Ma.error&&a.jsx("div",{className:ia,children:Ma.error}),a.jsxs("div",{className:ca,children:[a.jsx("button",{className:na,onClick:async()=>{if(Ma.app)try{Oa(a=>({...a,loading:!0,error:""}));const{init_point:a}=await e(`/api/apps/${encodeURIComponent(Ma.app.id)}/purchase`,{method:"POST"});a?window.open(a,"_blank","noopener"):Oa(a=>({...a,error:"Nao foi possivel iniciar o checkout"}))}catch(a){Oa(e=>({...e,error:a.message||"Erro ao iniciar pagamento"}))}finally{Oa(a=>({...a,loading:!1}))}},disabled:Ma.loading,children:Ma.loading?"Iniciando...":"Pagar com Mercado Pago"}),a.jsx("button",{className:da,onClick:async()=>{if(Ma.app)try{Oa(a=>({...a,checking:!0,downloadError:"",status:"checking"}));const a=await l(Ma.app.id),e=a?.status||a?.data?.status||"unknown";"approved"===e||"paid"===e?(Oa(a=>({...a,status:"approved",checking:!1})),await qa(Ma.app)):Oa("pending"===e?a=>({...a,status:"pending",checking:!1}):a=>({...a,status:"unknown",checking:!1}))}catch(a){Oa(e=>({...e,checking:!1,downloadError:a.message||"Erro ao verificar pagamento"}))}},disabled:Ma.checking,children:Ma.checking?"Verificando...":"Verificar pagamento"}),a.jsx("button",{className:da,onClick:()=>window.open(`/apps/${Ma.app?.id}/compra`,"_blank","noopener"),children:"Tela de pagamento"}),a.jsx("button",{className:da,onClick:()=>Oa({open:!1,app:null,loading:!1,error:""}),children:"Fechar"})]}),"approved"===Ma.status&&a.jsx(_,{appId:Ma.app?.id}),("downloading"===Ma.status||"done"===Ma.status)&&a.jsxs("div",{className:la,"aria-live":"polite",children:[a.jsx("div",{className:pa,children:a.jsx("div",{className:ua,style:{width:`${Ma.progress}%`}})}),a.jsx("p",{className:ha,children:"done"===Ma.status?"Download concluido!":`Baixando... ${Ma.progress}%`})]}),Ma.downloadError&&a.jsx("div",{className:ia,children:Ma.downloadError})]})})]})};export{_a as default};
