import{j as a,n as e,o as s,k as i,p as r,q as o,r as n,A as t}from"./index-CIPZqoX5.js";import{e as l,f as d,r as c,L as m}from"./router-5U3rcizL.js";import{N as p}from"./Navbar-CIznmG3J.js";import{u}from"./useAnalytics-to8QjZQP.js";import{e as _,b as h,r as x,i as y}from"./appsAPI-Cc93uQaT.js";const j="_container_qy0ya_3",f="_card_qy0ya_14",g="_iconWrapper_qy0ya_38",v="_title_qy0ya_53",N="_appName_qy0ya_64",w="_message_qy0ya_68",b="_orderInfo_qy0ya_75",q="_downloadSection_qy0ya_89",S="_downloadButton_qy0ya_93",k="_instructions_qy0ya_126",$="_instructionsTitle_qy0ya_134",E="_steps_qy0ya_144",A="_emailSection_qy0ya_177",C="_emailTitle_qy0ya_183",z="_emailForm_qy0ya_189",P="_emailInput_qy0ya_195",V="_emailButton_qy0ya_210",W="_homeLink_qy0ya_225",I="_loading_qy0ya_239",T=a=>{if(!a)return"";if(a.startsWith("http://")||a.startsWith("https://"))return a;const e=a.startsWith("/")?a:`/${a}`;return e.startsWith("/api/")?`${t}${e}`:e.startsWith("/downloads/")?`${t}/api${e}`:`${t}${e}`},B=()=>{const{id:t}=l(),[B]=d(),[F,L]=c.useState(null),[R,D]=c.useState(!0),[O,U]=c.useState("validating"),[G,H]=c.useState(""),[J,K]=c.useState(""),[M,Q]=c.useState(""),[X,Y]=c.useState("idle"),[Z,aa]=c.useState(""),{trackEvent:ea}=u();c.useEffect(()=>{(async()=>{try{const e=await _(t);L(e?.data||e);const s=B.get("preference_id"),i=B.get("payment_id"),r=B.get("status");i&&K(i);const o=await h(t,{preference_id:s,payment_id:i,status:r}),n=o?.data||o,l=n?.status||r;if("approved"===l)if(U("approved"),ea("purchase_success",{app_id:t,app_name:e?.name,payment_id:i,price:e?.price},"conversion"),n?.download_url)H(T(n.download_url));else try{const a=await x(t,{payment_id:i}),e=a?.data||a;e?.download_url&&H(T(e.download_url)),e?.email&&Q(e.email)}catch(a){}else U("pending"===l||"in_process"===l?"pending":"error")}catch(e){U("error")}finally{D(!1)}})()},[t,B,ea]);return R?a.jsx("div",{className:`${j} page-with-background`,children:a.jsxs("div",{className:I,children:[a.jsx(e,{className:"icon-spin"})," Verificando pedido..."]})}):"error"===O?a.jsx("div",{className:`${j} page-with-background`,children:a.jsxs("div",{className:f,children:[a.jsx("div",{className:g,style:{color:"#ff4444",borderColor:"#ff4444"},children:a.jsx("span",{style:{fontSize:"40px"},children:"⚠️"})}),a.jsx("h1",{className:v,children:"Ops! Algo deu errado."}),a.jsx("p",{className:w,children:"Não conseguimos confirmar seu pagamento. Se você já pagou, aguarde alguns instantes e atualize a página."}),a.jsx(m,{to:`/apps/${t}/compra`,className:S,style:{background:"transparent",border:"1px solid #fff"},children:"Voltar e tentar novamente"})]})}):"pending"===O?a.jsx("div",{className:`${j} page-with-background`,children:a.jsxs("div",{className:f,children:[a.jsx("div",{className:g,style:{color:"#ffbb33",borderColor:"#ffbb33"},children:a.jsx(e,{className:"icon-spin"})}),a.jsx("h1",{className:v,children:"Pagamento em Processamento"}),a.jsx("p",{className:w,children:"Estamos aguardando a confirmação do seu pagamento. Assim que aprovado, o download será liberado automaticamente."}),a.jsx("button",{onClick:()=>window.location.reload(),className:S,children:"Atualizar Status"})]})}):a.jsxs(a.Fragment,{children:[a.jsx(p,{}),a.jsx("div",{className:`${j} page-with-background`,children:a.jsxs("div",{className:f,children:[a.jsx("div",{className:g,children:a.jsx(s,{})}),a.jsxs("h1",{className:v,children:["Parabéns pela compra do ",a.jsx("span",{className:N,children:F?.name||"App"}),"!"]}),a.jsx("p",{className:w,children:"Sua licença foi ativada com sucesso. Você já pode baixar e instalar seu software."}),J&&a.jsxs("div",{className:b,children:["Número do Pedido: ",a.jsxs("strong",{children:["#",J]})]}),a.jsx("div",{className:q,children:a.jsxs("button",{onClick:async()=>{if(G)window.open(G,"_blank","noopener");else try{if(J){const a=await x(t,{payment_id:J}),e=a?.data||a;if(e?.download_url){const a=T(e.download_url);return H(a),e?.email&&Q(e.email),void window.open(a,"_blank","noopener")}}if(M){const a=await x(t,{email:M}),e=a?.data||a;if(e?.download_url){const a=T(e.download_url);return H(a),void window.open(a,"_blank","noopener")}}alert("Não foi possível obter o link de download. Por favor, use o campo abaixo para receber por e-mail.")}catch(a){alert("Erro ao processar download: "+(a?.message||"Tente novamente"))}},className:S,disabled:"approved"===!O,children:[a.jsx(i,{size:24})," Baixar Executável"]})}),a.jsxs("div",{className:k,children:[a.jsxs("h3",{className:$,children:[a.jsx(r,{size:14,color:"var(--cor-primaria)"})," Como instalar:"]}),a.jsxs("ol",{className:E,children:[a.jsx("li",{children:"Clique no botão acima para baixar o instalador."}),a.jsxs("li",{children:["Execute o arquivo ",a.jsx("strong",{children:".exe"})," baixado."]}),a.jsx("li",{children:"Siga as instruções na tela para concluir a instalação."}),a.jsx("li",{children:"Ao abrir o app, use seu e-mail para ativar se solicitado."})]})]}),a.jsxs("div",{className:A,children:[a.jsxs("h4",{className:C,children:[a.jsx(o,{style:{marginRight:8,verticalAlign:"middle"}}),"Reenviar link por e-mail"]}),a.jsxs("form",{onSubmit:async a=>{if(a.preventDefault(),M){Y("sending");try{const a=await y(t,M),e=a?.data||a;if(!e?.sent&&!e?.success)throw new Error(e?.message||"Não foi possível enviar o email.");Y("sent"),aa("Email enviado com sucesso! Verifique sua caixa de entrada."),e?.download_url&&H(T(e.download_url))}catch(e){Y("error");aa(e?.response?.data?.error?.message||e?.message||"Erro ao enviar. Verifique o e-mail.")}}},className:z,children:[a.jsx("input",{type:"email",placeholder:"Seu melhor e-mail",className:P,value:M,onChange:a=>Q(a.target.value),id:"email-input",required:!0}),a.jsx("button",{type:"submit",className:V,disabled:"sending"===X,children:"sending"===X?"Enviando...":"Enviar"})]}),Z&&a.jsx("p",{style:{marginTop:8,fontSize:"0.9rem",color:"error"===X?"#ff4444":"#00e4f2"},children:Z})]}),a.jsxs(m,{to:"/",className:W,children:[a.jsx(n,{})," Voltar para a página inicial"]})]})})]})};export{B as default};
