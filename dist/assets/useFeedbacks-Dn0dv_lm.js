import{r as e}from"./router-5U3rcizL.js";import{A as t}from"./index-B9S7B1ct.js";const a={maxChars:500,validate(e){const t=[];if(!e)return{isValid:!1,errors:["Feedback ausente"]};const{nome:r="",mensagem:i="",email:o=""}=e;return r.trim()||t.push("Nome é obrigatório"),i.trim()?i.length<10?t.push("Mensagem deve ter pelo menos 10 caracteres"):i.length>a.maxChars&&t.push(`Mensagem deve ter no máximo ${a.maxChars} caracteres`):t.push("Mensagem é obrigatória"),o&&!o.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)&&t.push("Email deve ter um formato válido"),{isValid:0===t.length,errors:t}},sanitize:e=>({nome:String(e.nome||"").trim(),email:String(e.email||"").trim(),mensagem:String(e.mensagem||"").trim().slice(0,a.maxChars),origem:e.origem||"pagina_inicial"})};function r(e){return Boolean(e&&String(e).trim().length>0)}async function i(e,{honeypot:i=""}={}){if(r(i))throw new Error("Submissão inválida.");if(!function(){const e=Number(localStorage.getItem("feedback_last_submit")||0);return Date.now()-e>3e4}())throw new Error("Você enviou um feedback há pouco. Tente novamente em instantes.");const{isValid:o,errors:n}=a.validate(e);if(!o){const e=new Error("Campos inválidos: "+n.join(", "));throw e.details=n,e}const s=a.sanitize(e);try{const e=await fetch(`${t}/api/feedbacks`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(s)}),a=await e.json().catch(()=>({}));if(!e.ok)throw new Error(a.error||`Erro ${e.status} ao enviar feedback.`);return localStorage.setItem("feedback_last_submit",String(Date.now())),a}catch(c){if(c instanceof TypeError)throw new Error("Não foi possível conectar ao servidor. Verifique sua internet.");throw c}}function o(o={}){const{autoFetch:n=!0,pageSize:s=5,origem:c="pagina_inicial"}=o,[m,l]=e.useState([]),[g,u]=e.useState(!1),[p,h]=e.useState(null),[f,d]=e.useState(1),[w,S]=e.useState({origem:c}),[y,b]=e.useState({page:1,limit:s,total:0,totalPages:0}),E=e.useCallback(async(e={})=>{u(!0),h(null);try{const a=await async function({page:e=1,limit:a=10,origem:r="pagina_inicial"}={}){const i=new URLSearchParams({limit:a.toString()});r&&i.append("origem",r);const o=`${t}/api/feedbacks?${i.toString()}`;try{const t=await fetch(o,{headers:{Accept:"application/json"}}),r=await t.json().catch(()=>({}));if(!t.ok)throw new Error(r.error||`Erro ${t.status} ao buscar feedbacks.`);const i=(r?.data||(Array.isArray(r)?r:[])).map(e=>({id:e.id,nome:e.nome||"Anônimo",email:e.email||"",mensagem:e.mensagem||e.comment||"",origem:e.origem||"site",rating:e.rating||5,data_criacao:e.data_criacao||e.createdAt})),n=i.length,s=Math.ceil(n/a);return{items:i.slice((e-1)*a,e*a),pagination:{page:e,limit:a,total:n,totalPages:s}}}catch(p){if(p instanceof TypeError)throw new Error("Não foi possível conectar ao servidor. Verifique sua internet.");throw p}}({page:e.page||f,limit:s,origem:e.origem??w.origem});l(a.items),b(a.pagination)}catch(a){h({message:a.message})}finally{u(!1)}},[f,s,w.origem]),v=e.useCallback(async(e,{honeypot:t=""}={})=>{const{isValid:o,errors:n}=a.validate(e);if(!o){const e=new Error("Campos inválidos");throw e.details=n,e}if(r(t)){throw new Error("Submissão identificada como spam")}const s=await i(e,{honeypot:t});return await E({page:1}),s},[E]);return e.useEffect(()=>{n&&E({page:1})},[n,E]),{items:m,pagination:y,loading:g,error:p,page:f,setPage:e=>{d(e),E({page:e})},filters:w,setFilters:e=>{S(e),E({page:1,...e})},submit:v}}function n(){const[a,r]=e.useState([]),[i,o]=e.useState(!0),[n,s]=e.useState(null),c=e.useCallback(async()=>{o(!0),s(null);try{const e=await async function(){const e=`${t}/api/feedbacks/latest`;try{const t=await fetch(e,{headers:{Accept:"application/json"}}),a=await t.json().catch(()=>({}));if(!t.ok)throw new Error(a.error||`Erro ${t.status}`);return a?.data||[]}catch(n){return[]}}();r(e)}catch(e){s({message:e.message}),r([])}finally{o(!1)}},[]);return e.useEffect(()=>{c()},[c]),{items:a,loading:i,error:n,refresh:c}}export{o as a,n as u};
