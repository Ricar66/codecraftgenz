import{a,j as e,$ as s,af as l,aG as t,a2 as n,a7 as i,at as r,aH as o,aI as c,ak as d}from"./index-BHfn_mjD.js";import{r as u}from"./router-5U3rcizL.js";import{A as m,S as _}from"./StatusBadge-DaKUplcy.js";import{A as h}from"./AdminTable-CBF_eEER.js";const v={page:"_page_uvouc_7",header:"_header_uvouc_17",headerTitle:"_headerTitle_uvouc_31",headerIcon:"_headerIcon_uvouc_43",btnRefresh:"_btnRefresh_uvouc_89",spinning:"_spinning_uvouc_143",spin:"_spin_uvouc_143",statsGrid:"_statsGrid_uvouc_153",statCard:"_statCard_uvouc_167",statContent:"_statContent_uvouc_177",statValue:"_statValue_uvouc_191",statLabel:"_statLabel_uvouc_203",statTotal:"_statTotal_uvouc_215",statPending:"_statPending_uvouc_217",statApproved:"_statApproved_uvouc_219",statError:"_statError_uvouc_221",filtersCard:"_filtersCard_uvouc_227",filters:"_filters_uvouc_227",searchBox:"_searchBox_uvouc_249",searchIcon:"_searchIcon_uvouc_271",searchInput:"_searchInput_uvouc_281",filterGroup:"_filterGroup_uvouc_309",filterIcon:"_filterIcon_uvouc_321",filterSelect:"_filterSelect_uvouc_331",errorBox:"_errorBox_uvouc_365",retryBtn:"_retryBtn_uvouc_391",vendaId:"_vendaId_uvouc_415",tomadorCell:"_tomadorCell_uvouc_427",tomadorEmail:"_tomadorEmail_uvouc_449",actions:"_actions_uvouc_461",actionBtn:"_actionBtn_uvouc_471",actionSend:"_actionSend_uvouc_521",actionConsult:"_actionConsult_uvouc_523",pagination:"_pagination_uvouc_529",pageBtn:"_pageBtn_uvouc_549",pageInfo:"_pageInfo_uvouc_589",toast:"_toast_uvouc_601",slideIn:"_slideIn_uvouc_1",error:"_error_uvouc_365",overlay:"_overlay_uvouc_661",modal:"_modal_uvouc_685",xmlModal:"_xmlModal_uvouc_709",modalHeader:"_modalHeader_uvouc_717",closeBtn:"_closeBtn_uvouc_747",modalBody:"_modalBody_uvouc_785",modalFooter:"_modalFooter_uvouc_797",detailSection:"_detailSection_uvouc_817",detailRow:"_detailRow_uvouc_847",detailGroup:"_detailGroup_uvouc_861",detailLabel:"_detailLabel_uvouc_873",detailValue:"_detailValue_uvouc_887",errorMsg:"_errorMsg_uvouc_899",btnXml:"_btnXml_uvouc_927",btnSend:"_btnSend_uvouc_927",btnConsult:"_btnConsult_uvouc_927",btnCancel:"_btnCancel_uvouc_927",xmlSection:"_xmlSection_uvouc_1023",xmlPre:"_xmlPre_uvouc_1045",noXml:"_noXml_uvouc_1075"},x={pending:{label:"Pendente",variant:"warning"},submitted:{label:"Enviada",variant:"info"},approved:{label:"Aprovada",variant:"success"},rejected:{label:"Rejeitada",variant:"error"},cancelled:{label:"Cancelada",variant:"neutral"},error:{label:"Erro",variant:"error"}},p=()=>{const[p,j]=u.useState([]),[N,b]=u.useState(!0),[g,C]=u.useState(null),[f,S]=u.useState(null),[y,L]=u.useState(!1),[k,E]=u.useState(null),[I,V]=u.useState(!1),[B,G]=u.useState(""),[P,R]=u.useState(""),[w,$]=u.useState(null),[T,F]=u.useState({page:1,limit:20,total:0,totalPages:0}),[M,X]=u.useState(null),A=u.useCallback(async()=>{b(!0),C(null);try{const e=await async function(e={}){const s=new URLSearchParams;return e.page&&s.set("page",e.page),e.limit&&s.set("limit",e.limit),e.status&&s.set("status",e.status),e.cnpj&&s.set("cnpj",e.cnpj),e.dataInicio&&s.set("dataInicio",e.dataInicio),e.dataFim&&s.set("dataFim",e.dataFim),a(`/api/nfse?${s.toString()}`,{method:"GET"})}({status:B||void 0,page:T.page,limit:T.limit}),s=e?.data||e;j(s?.data||s?.items||[]);const l=s?.meta||{};F(a=>({...a,total:l.total||0,totalPages:l.totalPages||0}))}catch(e){C(e.message||"Erro ao carregar notas fiscais")}finally{b(!1)}},[B,T.page,T.limit]);u.useEffect(()=>{A()},[A]);const D=(a,e="success")=>{X({message:a,type:e}),setTimeout(()=>X(null),4e3)},z=u.useCallback(async e=>{try{const s=await async function(e){if(!e)throw new Error("id é obrigatório");return a(`/api/nfse/${encodeURIComponent(e)}`,{method:"GET"})}(e.id);S(s?.data?.data||s?.data||s),L(!0)}catch(s){D(s.message||"Erro ao carregar detalhes","error")}},[]),U=u.useCallback(()=>{L(!1),S(null)},[]),H=u.useCallback(async e=>{if(window.confirm("Enviar esta NFS-e para a prefeitura?")){$(e);try{await async function(e){return a(`/api/nfse/${encodeURIComponent(e)}/enviar`,{method:"POST"})}(e),D("NFS-e enviada para prefeitura com sucesso"),A(),f?.id===e&&U()}catch(s){D(s.message||"Erro ao enviar NFS-e","error")}finally{$(null)}}},[A,f,U]),q=u.useCallback(async e=>{$(e);try{await async function(e){return a(`/api/nfse/${encodeURIComponent(e)}/consultar`,{method:"GET"})}(e),D("Status atualizado com sucesso"),A(),f?.id===e&&U()}catch(s){D(s.message||"Erro ao consultar status","error")}finally{$(null)}},[A,f,U]),O=u.useCallback(async e=>{if(window.confirm("Tem certeza que deseja cancelar esta NFS-e?")){$(e);try{await async function(e){return a(`/api/nfse/${encodeURIComponent(e)}/cancelar`,{method:"POST",body:"{}"})}(e),D("NFS-e cancelada com sucesso"),A(),f?.id===e&&U()}catch(s){D(s.message||"Erro ao cancelar NFS-e","error")}finally{$(null)}}},[A,f,U]),Y=u.useCallback(async e=>{try{const s=await async function(e){return a(`/api/nfse/${encodeURIComponent(e)}/xml`,{method:"GET"})}(e);E(s?.data?.data||s?.data||s),V(!0)}catch(s){D(s.message||"Erro ao carregar XML","error")}},[]),J=u.useMemo(()=>{if(!P)return p;const a=P.toLowerCase();return p.filter(e=>(e.venda_id||"").toLowerCase().includes(a)||(e.nfse_numero||"").toLowerCase().includes(a)||(e.tomador?.documento||"").includes(a)||(e.tomador?.razao_social||"").toLowerCase().includes(a)||(e.tomador?.email||"").toLowerCase().includes(a))},[p,P]),K=u.useMemo(()=>{const a={pending:0,submitted:0,approved:0,rejected:0,cancelled:0,error:0,total:p.length};return p.forEach(e=>{void 0!==a[e.status]&&a[e.status]++}),a},[p]),Q=a=>a?new Date(a).toLocaleDateString("pt-BR"):"—",W=a=>null==a?"—":Number(a).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),Z=[{key:"venda_id",label:"Venda",render:a=>e.jsx("span",{className:v.vendaId,children:a||"—"})},{key:"status",label:"Status",render:a=>{const s=x[a]||{label:a,variant:"neutral"};return e.jsx(_,{variant:s.variant,children:s.label})}},{key:"tomador",label:"Tomador",render:(a,s)=>e.jsxs("div",{className:v.tomadorCell,children:[e.jsx("strong",{children:s.tomador?.razao_social||s.tomador?.documento||"—"}),s.tomador?.email&&e.jsx("span",{className:v.tomadorEmail,children:s.tomador.email})]})},{key:"servico",label:"Valor",render:(a,e)=>W(e.servico?.valor_servicos)},{key:"nfse_numero",label:"NFS-e",render:a=>a||"—"},{key:"data_emissao",label:"Emissao",render:a=>Q(a)},{key:"actions",label:"Acoes",render:(a,s)=>e.jsxs("div",{className:v.actions,children:[e.jsx("button",{className:v.actionBtn,onClick:a=>{a.stopPropagation(),z(s)},title:"Ver detalhes",children:e.jsx(d,{})}),"pending"===s.status&&e.jsx("button",{className:`${v.actionBtn} ${v.actionSend}`,onClick:a=>{a.stopPropagation(),H(s.id)},disabled:w===s.id,title:"Enviar para prefeitura",children:e.jsx(c,{})}),"submitted"===s.status&&e.jsx("button",{className:`${v.actionBtn} ${v.actionConsult}`,onClick:a=>{a.stopPropagation(),q(s.id)},disabled:w===s.id,title:"Consultar status",children:e.jsx(n,{})}),"error"===s.status&&e.jsx("button",{className:`${v.actionBtn} ${v.actionSend}`,onClick:a=>{a.stopPropagation(),H(s.id)},disabled:w===s.id,title:"Reenviar",children:e.jsx(c,{})})]})}];return e.jsxs("div",{className:v.page,children:[M&&e.jsxs("div",{className:`${v.toast} ${v[M.type]||""}`,children:["error"===M.type?e.jsx(s,{}):e.jsx(l,{}),e.jsx("span",{children:M.message})]}),e.jsxs("div",{className:v.header,children:[e.jsxs("div",{className:v.headerTitle,children:[e.jsx("div",{className:v.headerIcon,children:e.jsx(t,{})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Notas Fiscais (NFS-e)"}),e.jsx("p",{children:"Gestao de notas fiscais de servico eletronica"})]})]}),e.jsxs("button",{className:v.btnRefresh,onClick:A,disabled:N,children:[e.jsx(n,{className:N?v.spinning:""})," Atualizar"]})]}),e.jsxs("div",{className:v.statsGrid,children:[e.jsx(m,{variant:"outlined",className:v.statCard,children:e.jsxs("div",{className:v.statContent,children:[e.jsx("span",{className:`${v.statValue} ${v.statTotal}`,children:K.total}),e.jsx("span",{className:v.statLabel,children:"Total"})]})}),e.jsx(m,{variant:"outlined",className:v.statCard,children:e.jsxs("div",{className:v.statContent,children:[e.jsx("span",{className:`${v.statValue} ${v.statPending}`,children:K.pending}),e.jsx("span",{className:v.statLabel,children:"Pendentes"})]})}),e.jsx(m,{variant:"outlined",className:v.statCard,children:e.jsxs("div",{className:v.statContent,children:[e.jsx("span",{className:`${v.statValue} ${v.statApproved}`,children:K.approved}),e.jsx("span",{className:v.statLabel,children:"Aprovadas"})]})}),e.jsx(m,{variant:"outlined",className:v.statCard,children:e.jsxs("div",{className:v.statContent,children:[e.jsx("span",{className:`${v.statValue} ${v.statError}`,children:K.error+K.rejected}),e.jsx("span",{className:v.statLabel,children:"Erros"})]})})]}),e.jsx(m,{variant:"outlined",className:v.filtersCard,children:e.jsxs("div",{className:v.filters,children:[e.jsxs("div",{className:v.searchBox,children:[e.jsx(i,{className:v.searchIcon}),e.jsx("input",{type:"text",placeholder:"Buscar por venda, documento, email...",value:P,onChange:a=>R(a.target.value),className:v.searchInput})]}),e.jsxs("div",{className:v.filterGroup,children:[e.jsx(r,{className:v.filterIcon}),e.jsxs("select",{value:B,onChange:a=>{G(a.target.value),F(a=>({...a,page:1}))},className:v.filterSelect,children:[e.jsx("option",{value:"",children:"Todos os status"}),Object.entries(x).map(([a,s])=>e.jsx("option",{value:a,children:s.label},a))]})]})]})}),g&&e.jsxs("div",{className:v.errorBox,children:[e.jsx(s,{})," ",g,e.jsx("button",{onClick:A,className:v.retryBtn,children:"Tentar novamente"})]}),e.jsxs(m,{variant:"outlined",children:[e.jsx(h,{columns:Z,data:J,loading:N,hoverable:!0,onRowClick:z,emptyMessage:"Nenhuma nota fiscal encontrada"}),T.totalPages>1&&e.jsxs("div",{className:v.pagination,children:[e.jsx("button",{disabled:T.page<=1,onClick:()=>F(a=>({...a,page:a.page-1})),className:v.pageBtn,children:"Anterior"}),e.jsxs("span",{className:v.pageInfo,children:["Pagina ",T.page," de ",T.totalPages," (",T.total," registros)"]}),e.jsx("button",{disabled:T.page>=T.totalPages,onClick:()=>F(a=>({...a,page:a.page+1})),className:v.pageBtn,children:"Proxima"})]})]}),y&&f&&e.jsx("div",{className:v.overlay,onClick:U,children:e.jsxs("div",{className:v.modal,onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:v.modalHeader,children:[e.jsx("h2",{children:"Detalhes da NFS-e"}),e.jsx("button",{onClick:U,className:v.closeBtn,children:e.jsx(s,{})})]}),e.jsxs("div",{className:v.modalBody,children:[e.jsxs("div",{className:v.detailRow,children:[e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Status"}),e.jsx(_,{variant:x[f.status]?.variant||"neutral",children:x[f.status]?.label||f.status})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"ID"}),e.jsx("span",{className:v.detailValue,children:f.id})]})]}),e.jsxs("div",{className:v.detailSection,children:[e.jsx("h3",{children:"Venda"}),e.jsxs("div",{className:v.detailRow,children:[e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Venda ID"}),e.jsx("span",{className:v.detailValue,children:f.venda_id||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Data Emissao"}),e.jsx("span",{className:v.detailValue,children:Q(f.data_emissao)})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Valor"}),e.jsx("span",{className:v.detailValue,children:W(f.servico?.valor_servicos)})]})]})]}),e.jsxs("div",{className:v.detailSection,children:[e.jsx("h3",{children:"Tomador"}),e.jsxs("div",{className:v.detailRow,children:[e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Tipo"}),e.jsx("span",{className:v.detailValue,children:f.tomador?.tipo||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Documento"}),e.jsx("span",{className:v.detailValue,children:f.tomador?.documento||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Razao Social"}),e.jsx("span",{className:v.detailValue,children:f.tomador?.razao_social||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Email"}),e.jsx("span",{className:v.detailValue,children:f.tomador?.email||"—"})]})]})]}),e.jsxs("div",{className:v.detailSection,children:[e.jsx("h3",{children:"Servico"}),e.jsx("div",{className:v.detailRow,children:e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Descricao"}),e.jsx("span",{className:v.detailValue,children:f.servico?.descricao||"—"})]})}),e.jsxs("div",{className:v.detailRow,children:[e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"ISS Retido"}),e.jsx("span",{className:v.detailValue,children:f.servico?.iss_retido?"Sim":"Nao"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Aliquota ISS"}),e.jsx("span",{className:v.detailValue,children:f.servico?.aliquota_iss?`${f.servico.aliquota_iss}%`:"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Valor ISS"}),e.jsx("span",{className:v.detailValue,children:W(f.servico?.valor_iss)})]})]})]}),e.jsxs("div",{className:v.detailSection,children:[e.jsx("h3",{children:"Prefeitura"}),e.jsxs("div",{className:v.detailRow,children:[e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"NFS-e Numero"}),e.jsx("span",{className:v.detailValue,children:f.nfse_numero||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Codigo Verificacao"}),e.jsx("span",{className:v.detailValue,children:f.codigo_verificacao||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"Protocolo"}),e.jsx("span",{className:v.detailValue,children:f.protocolo||"—"})]}),e.jsxs("div",{className:v.detailGroup,children:[e.jsx("span",{className:v.detailLabel,children:"RPS"}),e.jsx("span",{className:v.detailValue,children:f.rps_numero?`${f.rps_numero}/${f.rps_serie||"1"}`:"—"})]})]}),f.mensagem_erro&&e.jsxs("div",{className:v.errorMsg,children:[e.jsx(s,{})," ",f.mensagem_erro]})]})]}),e.jsxs("div",{className:v.modalFooter,children:[e.jsxs("button",{className:v.btnXml,onClick:()=>Y(f.id),children:[e.jsx(o,{})," Ver XML"]}),("pending"===f.status||"error"===f.status)&&e.jsxs("button",{className:v.btnSend,onClick:()=>H(f.id),disabled:w===f.id,children:[e.jsx(c,{})," ",w===f.id?"Enviando...":"Enviar para Prefeitura"]}),"submitted"===f.status&&e.jsxs("button",{className:v.btnConsult,onClick:()=>q(f.id),disabled:w===f.id,children:[e.jsx(n,{})," ",w===f.id?"Consultando...":"Consultar Status"]}),"approved"===f.status&&e.jsxs("button",{className:v.btnCancel,onClick:()=>O(f.id),disabled:w===f.id,children:[e.jsx(s,{})," ",w===f.id?"Cancelando...":"Cancelar NFS-e"]})]})]})}),I&&k&&e.jsx("div",{className:v.overlay,onClick:()=>V(!1),children:e.jsxs("div",{className:`${v.modal} ${v.xmlModal}`,onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:v.modalHeader,children:[e.jsx("h2",{children:"XML da NFS-e"}),e.jsx("button",{onClick:()=>V(!1),className:v.closeBtn,children:e.jsx(s,{})})]}),e.jsxs("div",{className:v.modalBody,children:[k.xmlEnvio&&e.jsxs("div",{className:v.xmlSection,children:[e.jsx("h3",{children:"XML de Envio"}),e.jsx("pre",{className:v.xmlPre,children:k.xmlEnvio})]}),k.xmlRetorno&&e.jsxs("div",{className:v.xmlSection,children:[e.jsx("h3",{children:"XML de Retorno"}),e.jsx("pre",{className:v.xmlPre,children:k.xmlRetorno})]}),!k.xmlEnvio&&!k.xmlRetorno&&e.jsx("p",{className:v.noXml,children:"Nenhum XML disponivel. Envie a NFS-e para gerar o XML."})]})]})})]})};export{p as default};
